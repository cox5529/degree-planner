
@{
    ViewData["Title"] = "Select courses";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@model IList<Degree_Planner.Models.ViewModels.SelectCoursesVm>
<br/><br/><br/>

@foreach(var degreeElement in Model) {
    await Html.RenderPartialAsync("_SelectCoursesPartial", degreeElement);
}
<br />
<h2>Parameters</h2>
<label for="max-hours">Maximum hours per semester: </label>
<br />
<input type="number" name="max-hours" id="max-hours" />
<br />
<br />
<label for="min-hours">Minimum hours per semester: </label>
<br />
<input type="number" name="min-hours" id="min-hours" />
<br />
<br />
<label for="max-semesters">Minimum number of semesters to graduate: </label>
<br />
<input type="number" name="max-semesters" id="max-semesters" />
<br />
<br />
<button id="generate-button" class="btn btn-lg btn-secondary" onclick="generateSchedules()">Generate schedules</button>

@section scripts {
    <script>
        var courseOptions = @Html.Raw(Json.Serialize(Model));
        var selectionTableData = [];
        var takenTableData = [];
        var hiddenCourses = [];
        var hourRequirements = [];

        $(function() {
            console.log(courseOptions);
            for (var i = 0; i < courseOptions.length; i++) {
                var vm = courseOptions[i];
                selectionTableData.push([]);
                takenTableData.push([]);
                hiddenCourses.push([]);
                hourRequirements.push(vm.degreeElement.hours);
                vm.idPrefix = i;

                populateAll(vm.idPrefix, vm.degreeElement, vm.coursesTaken);
            }

            $("input[type=number]").keyup(function(e) {
                if (e.keyCode === 13) {
                    $("#generate-button").click();
                }
            });

        });

        function populateAll(modelId, data, taken) {
            selectionTableData[modelId] = [];
            takenTableData[modelId] = [];
            hiddenCourses[modelId] = [];
            for (var i = 0; i < data.members.courses.length; i++) {
                var course = data.members.courses[i];
                selectionTableData[modelId].push(course);
            }

            for (var i = 0; i < taken.length; i++) {
                var course = null;
                var found = false;
                for (var j = 0; j < selectionTableData[modelId].length; j++) {
                    course = selectionTableData[modelId][j];
                    if (course.courseID === taken[i]) {
                        found = true;
                        selectionTableData[modelId].splice(j, 1);
                        break;
                    }
                }

                if (found) {
                    hideCourse(course.courseID);
                    takenTableData[modelId].push({
                        taken: true,
                        elective: false,
                        course: course
                    });
                }
            }

            updateHours(modelId);
            populateSelectionTable(modelId);
            populateTakenTable(modelId);
        }

        function populateTakenTable(modelId) {
            var html = "";
            sortTakenCourses(takenTableData[modelId]);

            for (var i = 0; i < takenTableData[modelId].length; i++) {
                var data = takenTableData[modelId][i];
                var course = data.course;
                html += "<tr>";
                html += "<td>" + course.name + "</td>";
                html += "<td>" + course.department + " " + course.catalogNumber + "</td>";
                html += "<td><button onclick='removeCourse(" +
                    modelId +
                    ", " +
                    course.courseID +
                    ")'>Remove</button></td>";
                html += "</tr>";
            }
            $("#" + modelId + "-selected-courses").html(html);
        }

        function populateSelectionTable(modelId) {
            var html = "";
            sortCourses(selectionTableData[modelId]);
            
            for (var i = 0; i < selectionTableData[modelId].length; i++) {
                var course = selectionTableData[modelId][i];
                if (!course.catalogNumber.endsWith("E")) {
                    html += "<tr>";
                    html += "<td>" + course.name + "</td>";
                    html += "<td>" + course.department + " " + course.catalogNumber + "</td>";
                    html += "<td><button onclick='addCourse(" +
                        modelId +
                        ", " +
                        course.courseID +
                        ")'>Add</button></td>";
                    html += "</tr>";
                } else {
                    html += "<tr>";
                    if (course.department === "UARK") {
                        html += "<td>Any elective</td>";
                    } else {
                        html += "<td>" + course.department + " elective</td>";
                    }
                    if (course.catalogNumber === "000E") {
                        html += "<td></td>";
                    } else {
                        html += "<td>numbered greater than " + course.catalogNumber.substring(0, 3) + "0</td>";
                    }
                    html += "<td></td></tr>";
                }
            }
            $("#" + modelId + "-course-options").html(html);
        }

        function sortCourses(courseList) {
            courseList.sort(function (a, b) {
                console.log(a);
                var x = a.department.toLowerCase();
                var y = b.department.toLowerCase();
                if (x < y) { return -1; }
                if (x > y) { return 1; }

                x = a.catalogNumber.toLowerCase();
                y = b.catalogNumber.toLowerCase();
                if (x < y) { return -1; }
                if (x > y) { return 1; }
                return 0;
            });
        }

        function sortTakenCourses(courseList) {
            courseList.sort(function (a, b) {
                console.log(a);
                var x = a.course.department.toLowerCase();
                var y = b.course.department.toLowerCase();
                if (x < y) { return -1; }
                if (x > y) { return 1; }

                x = a.course.catalogNumber.toLowerCase();
                y = b.course.catalogNumber.toLowerCase();
                if (x < y) { return -1; }
                if (x > y) { return 1; }
                return 0;
            });
        }

        function hideCourse(courseId, exclude) {
            for (var i = 0; i < selectionTableData.length; i++) {
                if (i !== exclude) {
                    var table = selectionTableData[i];
                    for (var j = 0; j < table.length; j++) {
                        if (table[j].courseID === courseId) {
                            hiddenCourses[i].push(table[j]);
                            table.splice(j, 1);

                            populateSelectionTable(i);
                            break;
                        }
                    }
                }
            }
        }

        function unhideCourse(courseId) {
            for (var i = 0; i < hiddenCourses.length; i++) {
                var table = hiddenCourses[i];
                for (var j = 0; j < table.length; j++) {
                    if (table[j].courseID === courseId) {
                        selectionTableData[i].push(table[j]);
                        table.splice(j, 1);

                        populateSelectionTable(i);
                        break;
                    }
                }
            }
        }

        function addCourse(modelId, courseId, tryRemove = true) {
            if (tryRemove) {
                for (var i = 0; i < takenTableData.length; i++) {
                    var table = takenTableData[i];
                    for (var j = 0; j < table.length; j++) {
                        var element = table[j];
                        if (element.course.courseID === courseId) {
                            return;
                        }
                    }
                }
                var course;
                var found = -1;
                for (var i = 0; i < selectionTableData[modelId].length; i++) {
                    course = selectionTableData[modelId][i];
                    if (course.courseID === courseId) {
                        found = i;
                        break;
                    }
                }
                if (found !== -1) {
                    selectionTableData[modelId].splice(found, 1);
                    takenTableData[modelId].push({
                        taken: false,
                        elective: false,
                        course: course
                    });

                    hideCourse(course.courseID, modelId);
                    updateHours(modelId);
                    populateTakenTable(modelId);
                    populateSelectionTable(modelId);
                }
            } else {
                for (var i = 0; i < takenTableData.length; i++) {
                    var table = takenTableData[i];
                    for (var j = 0; j < table.length; j++) {
                        var element = table[j];
                        if (element.course.department === courseId.department &&
                            element.course.catalogNumber === courseId.catalogNumber) {
                            return;
                        }
                    }
                }
                $.ajax({
                    type: "POST",
                    timeout: 10000,
                    data: {
                        degreeElementId: courseOptions[modelId].degreeElement.degreeElementID,
                        department: courseId.department,
                        catalog: courseId.catalogNumber,
                        degreeId: @ViewBag.DegreeId
                    },
                    url: "@Url.Action("CanAddElective", "Planner")",
                    success: function(data) {
                        if (data.allow) {
                            courseId.name = data.name;
                            courseId.courseID = data.courseID;
                            takenTableData[modelId].push({
                                taken: false,
                                elective: true,
                                course: courseId
                            });
                            updateHours(modelId);
                        }
                        hideCourse(data.courseID, modelId);
                        populateTakenTable(modelId);
                        populateSelectionTable(modelId);
                    }
                });
            }
        }

        function removeCourse(modelId, courseId) {
            var course;
            var elective;
            var found = -1;
            for (var i = 0; i < takenTableData[modelId].length; i++) {
                course = takenTableData[modelId][i].course;
                elective = takenTableData[modelId][i].elective;
                if (course.courseID === courseId) {
                    found = i;
                    break;
                }
            }
            if (found !== -1) {
                takenTableData[modelId].splice(found, 1);
                if (!elective) {
                    selectionTableData[modelId].push(course);
                }
                unhideCourse(courseId);
                updateHours(modelId);
            }


            populateTakenTable(modelId);
            populateSelectionTable(modelId);
        }

        function updateHours(modelId) {
            var hourCount = 0;
            for (var i = 0; i < takenTableData[modelId].length; i++) {
                hourCount += takenTableData[modelId][i].course.hours;
            }
            var remainingHours = hourRequirements[modelId] - hourCount;
            if (remainingHours < 0) remainingHours = 0;

            if (remainingHours === 0) {
                $("#" + modelId + "-div-options").css("display", "none");
            } else {
                $("#" + modelId + "-div-options").css("display", "block");
            }

            $("#" + modelId + "-hours-remaining").html(remainingHours + "");
        }

        function generateSchedules() {
            for (var i = 0; i < hourRequirements.length; i++) {
                var html = $("#" + i + "-hours-remaining").html();
                if (html !== "0") return; //TODO display error
            }
            var courses = [];
            for (var i = 0; i < courseOptions.length; i++) {
                for (var j = 0; j < takenTableData[i].length; j++) {
                    var course = takenTableData[i][j].course;
                    course.CourseUserLinks = [];
                    courses.push(course);
                }
            }

            var maxHoursStr = $("#max-hours").val();
            var minHoursStr = $("#min-hours").val();
            var minSemestersStr = $("#max-semesters").val();

            if (minHoursStr === "" || maxHoursStr === "" || minSemestersStr === "") {
                //TODO display error
                return;
            }

            var maxHours = parseInt(maxHoursStr);
            var minHours = parseInt(minHoursStr);
            var minSemesters = parseInt(minSemestersStr);

            if (maxHours <= 0 || minHours <= 0 || minSemesters < 0 || minHours > maxHours) {
                return; //TODO display error
            }

            var postData = {
                degreeID: @ViewBag.DegreeId,
                courses: courses,
                minHoursPerSemester: minHours,
                maxHoursPerSemester: maxHours,
                minSemesters: minSemesters
            };

            console.log(postData);
            $.redirect("@Url.Action("ViewDegreePlan", "Planner")", postData);
        }

    </script>
}
